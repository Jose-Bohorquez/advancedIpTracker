<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced IP Tracker - Dashboard Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Alpine.js for reactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        danger: {
                            500: '#ef4444',
                            600: '#dc2626'
                        },
                        success: {
                            500: '#10b981',
                            600: '#059669'
                        },
                        warning: {
                            500: '#f59e0b',
                            600: '#d97706'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        /* Enhanced Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Enhanced Card Animations */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        
        /* Enhanced Buttons */
        .btn-enhanced {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-enhanced:hover::before {
            left: 100%;
        }
        
        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }
        
        /* Enhanced Form Controls */
        .form-control-enhanced {
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .form-control-enhanced:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-high {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .status-medium {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .status-low {
            background-color: #d1fae5;
            color: #059669;
        }
        
        /* Chart Container Enhancements */
        .chart-container {
            position: relative;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            height: auto;
            max-height: 400px;
            overflow: hidden;
        }
        
        .chart-container:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        /* Canvas Chart Fixes */
        canvas {
            max-width: 100% !important;
            height: auto !important;
            max-height: 300px !important;
        }
        
        #riskChart, #countryChart, #activityChart {
            max-height: 250px !important;
            height: 250px !important;
        }
        
        #browserChart {
            max-height: 200px !important;
            height: 200px !important;
        }
        
        #behaviorChart, #temporalChart {
            max-height: 250px !important;
            height: 250px !important;
        }
        
        /* Modal Enhancements */
        .modal-enhanced {
            backdrop-filter: blur(8px);
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content-enhanced {
            border-radius: 16px;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* Toast Notifications */
        .toast-enhanced {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease-out;
        }
        
        /* Loading States */
        .loading-pulse {
            animation: pulse 2s infinite;
        }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .card-hover:hover {
                transform: translateY(-2px);
            }
        }
        
        /* Sidebar Enhancements */
        .sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 50;
                height: 100vh;
                background-color: rgba(255, 255, 255, 0.95);
            }
        }
        
        /* Table Enhancements */
        .table-enhanced {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .table-enhanced thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }
        
        .table-enhanced tbody tr {
            transition: all 0.2s ease;
        }
        
        .table-enhanced tbody tr:hover {
            background-color: #f8fafc;
            transform: scale(1.005);
        }
        
        /* Toast positioning */
        .toast {
            z-index: 9999;
        }
    </style>
        
        .json-viewer {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .copy-button {
            transition: all 0.2s ease;
        }
        
        .copy-button:hover {
            transform: scale(1.05);
        }
        
        .sidebar-item {
            transition: all 0.3s ease;
        }
        
        .sidebar-item:hover {
            transform: translateX(4px);
        }
    </style>
</head>
<body class="h-full" x-data="dashboardApp()">
    <div class="min-h-full">
        <!-- Navigation -->
        <nav class="gradient-bg shadow-lg">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-shield-alt text-white text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h1 class="text-xl font-bold text-white">Advanced IP Tracker Pro</h1>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Settings Button -->
                        <button @click="showSettings = !showSettings" 
                                class="text-white hover:text-gray-200 transition-colors">
                            <i class="fas fa-cog text-lg"></i>
                        </button>
                        
                        <!-- Current Time -->
                        <div class="text-white text-sm">
                            <i class="fas fa-clock mr-1"></i>
                            <span x-text="currentTime"></span>
                        </div>
                        
                        <!-- Auto Refresh Toggle -->
                        <div class="flex items-center">
                            <label class="inline-flex items-center">
                                <input type="checkbox" x-model="autoRefresh" class="form-checkbox h-4 w-4 text-primary-600">
                                <span class="ml-2 text-white text-sm">Auto-refresh</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex">
            <!-- Sidebar -->
            <div class="w-64 bg-white shadow-lg min-h-screen">
                <nav class="mt-5 px-2">
                    <template x-for="item in menuItems" :key="item.id">
                        <a href="#" 
                           @click="activeSection = item.id"
                           :class="activeSection === item.id ? 'bg-primary-100 text-primary-700 border-r-2 border-primary-500' : 'text-gray-600 hover:bg-gray-50'"
                           class="sidebar-item group flex items-center px-2 py-2 text-sm font-medium rounded-md mb-1">
                            <i :class="item.icon" class="mr-3 h-5 w-5"></i>
                            <span x-text="item.name"></span>
                        </a>
                    </template>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="flex-1 p-6">
                <!-- Dashboard Section -->
                <div x-show="activeSection === 'dashboard'" x-cloak>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard General</h2>
                        <p class="text-gray-600">Resumen de actividad y estadísticas del sistema</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white overflow-hidden shadow-lg rounded-xl card-hover border border-gray-100">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                                        <i class="fas fa-users text-xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-600">Total Sesiones</p>
                                        <p class="text-2xl font-bold text-gray-900" x-text="stats.totalSessions || '-'"></p>
                                        <p class="text-xs text-green-600 flex items-center mt-1">
                                            <i class="fas fa-arrow-up mr-1"></i>
                                            +12% vs mes anterior
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-lg rounded-xl card-hover border border-gray-100">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                                        <i class="fas fa-globe text-xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-600">IPs Únicas</p>
                                        <p class="text-2xl font-bold text-gray-900" x-text="stats.uniqueIPs || '-'"></p>
                                        <p class="text-xs text-blue-600 flex items-center mt-1">
                                            <i class="fas fa-map-marker-alt mr-1"></i>
                                            Cobertura global
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-lg rounded-xl card-hover border border-gray-100">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                                        <i class="fas fa-robot text-xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-600">Automatización</p>
                                        <p class="text-2xl font-bold text-gray-900" x-text="stats.automationDetected || '-'"></p>
                                        <p class="text-xs text-orange-600 flex items-center mt-1">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>
                                            Detección activa
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-lg rounded-xl card-hover border border-gray-100">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-red-100 text-red-600 mr-4">
                                        <i class="fas fa-mask text-xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-600">Uso de Proxy</p>
                                        <p class="text-2xl font-bold text-gray-900" x-text="stats.proxyUsage || '-'"></p>
                                        <p class="text-xs text-red-600 flex items-center mt-1">
                                            <i class="fas fa-shield-alt mr-1"></i>
                                            Requiere monitoreo
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                        <!-- Risk Distribution Chart -->
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-shield-alt text-red-500 mr-2"></i>
                                    Distribución de Riesgos
                                </h3>
                                <div class="text-xs text-gray-500">Últimas 24h</div>
                            </div>
                            <canvas id="riskChart" class="w-full h-64"></canvas>
                            <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                                <div class="p-2 bg-green-50 rounded">
                                    <div class="text-sm font-semibold text-green-600" x-text="stats.lowRisk || '0'"></div>
                                    <div class="text-xs text-gray-600">Bajo</div>
                                </div>
                                <div class="p-2 bg-yellow-50 rounded">
                                    <div class="text-sm font-semibold text-yellow-600" x-text="stats.mediumRisk || '0'"></div>
                                    <div class="text-xs text-gray-600">Medio</div>
                                </div>
                                <div class="p-2 bg-red-50 rounded">
                                    <div class="text-sm font-semibold text-red-600" x-text="stats.highRisk || '0'"></div>
                                    <div class="text-xs text-gray-600">Alto</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Countries Chart -->
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-globe text-blue-500 mr-2"></i>
                                    Países Principales
                                </h3>
                                <div class="text-xs text-gray-500">Top 10</div>
                            </div>
                            <canvas id="countryChart" class="w-full h-64"></canvas>
                        </div>

                        <!-- Activity Timeline Chart -->
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-chart-line text-purple-500 mr-2"></i>
                                    Actividad por Hora
                                </h3>
                                <div class="text-xs text-gray-500">Últimas 24h</div>
                            </div>
                            <canvas id="activityChart" class="w-full h-64"></canvas>
                        </div>
                    </div>

                    <!-- Additional Analytics -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Browser Distribution -->
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-browser text-indigo-500 mr-2"></i>
                                Navegadores Más Utilizados
                            </h3>
                            <canvas id="browserChart" class="w-full h-48"></canvas>
                        </div>

                        <!-- Threat Detection -->
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>
                                Detección de Amenazas
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-robot text-red-500 mr-3"></i>
                                        <span class="text-sm font-medium">Bots Detectados</span>
                                    </div>
                                    <span class="text-lg font-bold text-red-600" x-text="stats.automationDetected || '0'"></span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-mask text-orange-500 mr-3"></i>
                                        <span class="text-sm font-medium">Proxies/VPN</span>
                                    </div>
                                    <span class="text-lg font-bold text-orange-600" x-text="stats.proxyUsage || '0'"></span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-flag text-yellow-500 mr-3"></i>
                                        <span class="text-sm font-medium">IPs Sospechosas</span>
                                    </div>
                                    <span class="text-lg font-bold text-yellow-600" x-text="stats.suspiciousIPs || '0'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sessions Section -->
                <div x-show="activeSection === 'sessions'" x-cloak>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Gestión de Sesiones</h2>
                        <p class="text-gray-600">Visualiza y analiza todas las sesiones registradas</p>
                    </div>

                    <!-- Sessions Table -->
                    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-4 sm:space-y-0">
                                <h3 class="text-lg font-medium text-gray-900">Sesiones Recientes</h3>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                                    <!-- Advanced Filters -->
                                    <div class="flex space-x-2">
                                        <select x-model="filterRisk" 
                                                class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                                            <option value="">Todos los riesgos</option>
                                            <option value="alto">Alto Riesgo</option>
                                            <option value="medio">Medio Riesgo</option>
                                            <option value="bajo">Bajo Riesgo</option>
                                        </select>
                                        
                                        <select x-model="filterCountry" 
                                                class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                                            <option value="">Todos los países</option>
                                            <option value="CO">Colombia</option>
                                            <option value="VE">Venezuela</option>
                                            <option value="US">Estados Unidos</option>
                                            <option value="BR">Brasil</option>
                                        </select>
                                        
                                        <select x-model="filterTimeRange" 
                                                class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                                            <option value="">Todo el tiempo</option>
                                            <option value="1h">Última hora</option>
                                            <option value="24h">Últimas 24 horas</option>
                                            <option value="7d">Últimos 7 días</option>
                                            <option value="30d">Últimos 30 días</option>
                                        </select>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <input type="text" 
                                               x-model="sessionFilter" 
                                               placeholder="Buscar por IP, país, navegador..."
                                               class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 min-w-64">
                                        
                                        <button @click="clearFilters()" 
                                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                            <i class="fas fa-times mr-2"></i>Limpiar
                                        </button>
                                        
                                        <button @click="loadSessions()" 
                                                class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                            <i class="fas fa-sync-alt mr-2"></i>Actualizar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center p-3 bg-blue-50 rounded-lg">
                                    <div class="text-lg font-bold text-blue-600" x-text="filteredSessions.length"></div>
                                    <div class="text-xs text-gray-600">Total Filtradas</div>
                                </div>
                                <div class="text-center p-3 bg-red-50 rounded-lg">
                                    <div class="text-lg font-bold text-red-600" x-text="filteredSessions.filter(s => s.risk_level === 'alto').length"></div>
                                    <div class="text-xs text-gray-600">Alto Riesgo</div>
                                </div>
                                <div class="text-center p-3 bg-orange-50 rounded-lg">
                                    <div class="text-lg font-bold text-orange-600" x-text="filteredSessions.filter(s => s.is_proxy).length"></div>
                                    <div class="text-xs text-gray-600">Con Proxy</div>
                                </div>
                                <div class="text-center p-3 bg-purple-50 rounded-lg">
                                    <div class="text-lg font-bold text-purple-600" x-text="new Set(filteredSessions.map(s => s.country)).size"></div>
                                    <div class="text-xs text-gray-600">Países Únicos</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 table-enhanced">
                                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors"
                                            @click="sortSessions('session_id')">
                                            <div class="flex items-center">
                                                ID Sesión
                                                <i class="fas fa-sort ml-2 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors"
                                            @click="sortSessions('timestamp')">
                                            <div class="flex items-center">
                                                Timestamp
                                                <i class="fas fa-sort ml-2 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors"
                                            @click="sortSessions('client_ip')">
                                            <div class="flex items-center">
                                                IP Cliente
                                                <i class="fas fa-sort ml-2 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors"
                                            @click="sortSessions('location')">
                                            <div class="flex items-center">
                                                Ubicación
                                                <i class="fas fa-sort ml-2 text-gray-400"></i>
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Navegador</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Datos Avanzados</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Riesgo</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="session in filteredSessions" :key="session.session_id">
                                        <tr class="hover:bg-blue-50 transition-all duration-200 cursor-pointer border-l-4 border-transparent hover:border-blue-400">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0 w-2 h-2 bg-green-400 rounded-full mr-3 animate-pulse"></div>
                                                    <span class="font-mono text-xs bg-gray-100 px-3 py-1 rounded-full border" 
                                                          x-text="session.session_id.substring(0, 12) + '...'"></span>
                                                    <button @click="copyToClipboard(session.session_id)" 
                                                            class="ml-2 text-gray-400 hover:text-blue-600 transition-colors p-1 rounded hover:bg-blue-100">
                                                        <i class="fas fa-copy text-xs"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="flex flex-col">
                                                    <span x-text="formatDate(session.timestamp)"></span>
                                                    <span class="text-xs text-gray-400" x-text="getTimeAgo(session.timestamp)"></span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="flex items-center">
                                                    <span class="font-mono" x-text="session.client_ip"></span>
                                                    <button @click="copyToClipboard(session.client_ip)" 
                                                            class="ml-2 text-gray-400 hover:text-gray-600">
                                                        <i class="fas fa-copy text-xs"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="flex items-center">
                                                    <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>
                                                    <span x-text="session.location"></span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="flex items-center">
                                                    <i :class="getBrowserIcon(session.browser_info?.browser)" class="mr-2"></i>
                                                    <div>
                                                        <div x-text="session.browser_info?.browser || 'Desconocido'"></div>
                                                        <div class="text-xs text-gray-400" x-text="session.browser_info?.os || ''"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span :class="session.has_advanced_data ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'" 
                                                      class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full">
                                                    <i :class="session.has_advanced_data ? 'fas fa-check-circle' : 'fas fa-minus-circle'" class="mr-1"></i>
                                                    <span x-text="session.has_advanced_data ? 'Completos' : 'Básicos'"></span>
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span :class="getRiskBadgeClass(session.risk_level || 'bajo')" 
                                                      class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full">
                                                    <i :class="getRiskIcon(session.risk_level || 'bajo')" class="mr-1"></i>
                                                    <span x-text="(session.risk_level || 'bajo').toUpperCase()"></span>
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <div class="flex space-x-2">
                                                    <button @click="viewSession(session.session_id)" 
                                                            class="text-primary-600 hover:text-primary-900 transition-colors"
                                                            title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button @click="analyzeRisk(session.session_id)" 
                                                            class="text-warning-600 hover:text-warning-900 transition-colors"
                                                            title="Analizar riesgo">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                    </button>
                                                    <button @click="exportSession(session.session_id)" 
                                                            class="text-success-600 hover:text-success-900 transition-colors"
                                                            title="Exportar datos">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        
                        <div x-show="filteredSessions.length === 0" class="text-center py-12">
                            <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500">No se encontraron sesiones que coincidan con el filtro</p>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                            <div class="flex-1 flex justify-between sm:hidden">
                                <button @click="previousPage()" 
                                        :disabled="currentPage === 1"
                                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                    Anterior
                                </button>
                                <button @click="nextPage()" 
                                        :disabled="currentPage >= totalPages"
                                        class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                    Siguiente
                                </button>
                            </div>
                            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-sm text-gray-700">
                                        Mostrando <span class="font-medium" x-text="((currentPage - 1) * sessionsPerPage) + 1"></span> 
                                        a <span class="font-medium" x-text="Math.min(currentPage * sessionsPerPage, sessions.length)"></span> 
                                        de <span class="font-medium" x-text="sessions.length"></span> resultados
                                    </p>
                                </div>
                                <div>
                                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                        <button @click="previousPage()" 
                                                :disabled="currentPage === 1"
                                                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <template x-for="page in visiblePages" :key="page">
                                            <button @click="currentPage = page" 
                                                    :class="page === currentPage ? 'bg-primary-50 border-primary-500 text-primary-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'"
                                                    class="relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                                <span x-text="page"></span>
                                            </button>
                                        </template>
                                        <button @click="nextPage()" 
                                                :disabled="currentPage >= totalPages"
                                                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div x-show="activeSection === 'analytics'" x-cloak>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Análisis Avanzado</h2>
                        <p class="text-gray-600">Análisis detallado de patrones y comportamientos</p>
                    </div>

                    <!-- Analytics Dashboard -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Threat Analysis -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-red-500 mr-2"></i>
                                Análisis de Amenazas
                            </h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-red-800">IPs Sospechosas</p>
                                        <p class="text-sm text-red-600">Últimas 24 horas</p>
                                    </div>
                                    <span class="text-2xl font-bold text-red-600">12</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-orange-800">Intentos de Automatización</p>
                                        <p class="text-sm text-orange-600">Detectados hoy</p>
                                    </div>
                                    <span class="text-2xl font-bold text-orange-600">8</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-yellow-800">Conexiones VPN/Proxy</p>
                                        <p class="text-sm text-yellow-600">Esta semana</p>
                                    </div>
                                    <span class="text-2xl font-bold text-yellow-600">34</span>
                                </div>
                            </div>
                        </div>

                        <!-- Geographic Analysis -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-globe text-blue-500 mr-2"></i>
                                Análisis Geográfico
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Colombia</span>
                                    <div class="flex items-center">
                                        <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: 65%"></div>
                                        </div>
                                        <span class="text-sm font-medium">65%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Venezuela</span>
                                    <div class="flex items-center">
                                        <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-green-600 h-2 rounded-full" style="width: 20%"></div>
                                        </div>
                                        <span class="text-sm font-medium">20%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Estados Unidos</span>
                                    <div class="flex items-center">
                                        <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-purple-600 h-2 rounded-full" style="width: 10%"></div>
                                        </div>
                                        <span class="text-sm font-medium">10%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Otros</span>
                                    <div class="flex items-center">
                                        <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-gray-600 h-2 rounded-full" style="width: 5%"></div>
                                        </div>
                                        <span class="text-sm font-medium">5%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Analytics Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Patrones de Comportamiento</h3>
                            <canvas id="behaviorChart" class="w-full h-64"></canvas>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Análisis Temporal</h3>
                            <canvas id="temporalChart" class="w-full h-64"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div x-show="activeSection === 'reports'" x-cloak>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Reportes y Exportación</h2>
                        <p class="text-gray-600">Genera reportes detallados y exporta datos</p>
                    </div>

                    <!-- Report Generation -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Quick Reports -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-chart-bar text-primary-500 mr-2"></i>
                                Reportes Rápidos
                            </h3>
                            <div class="space-y-3">
                                <button @click="generateReport('daily')" 
                                        class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium text-gray-900">Reporte Diario</p>
                                            <p class="text-sm text-gray-600">Actividad de las últimas 24 horas</p>
                                        </div>
                                        <i class="fas fa-download text-gray-400"></i>
                                    </div>
                                </button>
                                <button @click="generateReport('weekly')" 
                                        class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium text-gray-900">Reporte Semanal</p>
                                            <p class="text-sm text-gray-600">Resumen de los últimos 7 días</p>
                                        </div>
                                        <i class="fas fa-download text-gray-400"></i>
                                    </div>
                                </button>
                                <button @click="generateReport('monthly')" 
                                        class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium text-gray-900">Reporte Mensual</p>
                                            <p class="text-sm text-gray-600">Análisis completo del mes</p>
                                        </div>
                                        <i class="fas fa-download text-gray-400"></i>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Custom Report Builder -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-cogs text-primary-500 mr-2"></i>
                                Reporte Personalizado
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Rango de Fechas</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="date" x-model="reportDateFrom" 
                                               class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                                        <input type="date" x-model="reportDateTo" 
                                               class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Incluir Datos</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" x-model="reportIncludeBasic" class="mr-2">
                                            <span class="text-sm">Datos básicos de sesión</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" x-model="reportIncludeLocation" class="mr-2">
                                            <span class="text-sm">Información de ubicación</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" x-model="reportIncludeDevice" class="mr-2">
                                            <span class="text-sm">Datos del dispositivo</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" x-model="reportIncludeRisk" class="mr-2">
                                            <span class="text-sm">Análisis de riesgo</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Formato</label>
                                    <select x-model="reportFormat" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                                        <option value="pdf">PDF</option>
                                        <option value="excel">Excel</option>
                                        <option value="csv">CSV</option>
                                        <option value="json">JSON</option>
                                    </select>
                                </div>
                                <button @click="generateCustomReport()" 
                                        class="w-full bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                                    <i class="fas fa-file-export mr-2"></i>Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export History -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-history text-primary-500 mr-2"></i>
                            Historial de Exportaciones
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Formato</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2024-01-15 14:30</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Reporte Semanal</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">PDF</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                Completado
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button class="text-primary-600 hover:text-primary-900 mr-3">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="text-red-600 hover:text-red-900">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Bait Links Section -->
                <div x-show="activeSection === 'bait-links'" x-cloak>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Enlaces Señuelo</h2>
                        <p class="text-gray-600">Enlaces listos para copiar y distribuir</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="bait in baitLinks" :key="bait.id">
                            <div class="bg-white rounded-lg shadow-lg overflow-hidden card-hover">
                                <div class="p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-semibold text-gray-900" x-text="bait.title"></h3>
                                        <i :class="bait.icon" class="text-2xl text-primary-500"></i>
                                    </div>
                                    
                                    <p class="text-gray-600 text-sm mb-4" x-text="bait.description"></p>
                                    
                                    <div class="bg-gray-50 rounded-md p-3 mb-4">
                                        <code class="text-sm text-gray-800 break-all" x-text="bait.url"></code>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button @click="copyToClipboard(bait.url)" 
                                                class="flex-1 bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors copy-button">
                                            <i class="fas fa-copy mr-2"></i>Copiar
                                        </button>
                                        <button @click="previewBait(bait.url)" 
                                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                            <i class="fas fa-eye mr-2"></i>Ver
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Settings Section -->
                <div x-show="activeSection === 'settings'" x-cloak>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Configuración del Sistema</h2>
                        <p class="text-gray-600">Personaliza el comportamiento del sistema de seguimiento</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Location Tracking Settings -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-map-marker-alt text-primary-500 mr-2"></i>
                                Seguimiento de Ubicación
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Duración de Persistencia (minutos)
                                    </label>
                                    <input type="number" 
                                           x-model="settings.locationPersistence" 
                                           min="1" 
                                           max="1440"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Tiempo que se mantiene activo el seguimiento de ubicación</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Intervalo de Actualización (minutos)
                                    </label>
                                    <input type="number" 
                                           x-model="settings.locationInterval" 
                                           min="1" 
                                           max="60"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Frecuencia de actualización de la ubicación</p>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                           x-model="settings.highAccuracyLocation" 
                                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-700">
                                        Usar alta precisión (consume más batería)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Data Retention Settings -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-database text-primary-500 mr-2"></i>
                                Retención de Datos
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Días de Retención
                                    </label>
                                    <input type="number" 
                                           x-model="settings.dataRetention" 
                                           min="1" 
                                           max="365"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                           x-model="settings.autoCleanup" 
                                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-700">
                                        Limpieza automática de datos antiguos
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Alert Settings -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-bell text-primary-500 mr-2"></i>
                                Configuración de Alertas
                            </h3>
                            
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                           x-model="settings.alertHighRisk" 
                                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-700">
                                        Alertas de Alto Riesgo
                                    </label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                           x-model="settings.alertAutomation" 
                                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-700">
                                        Detección de Automatización
                                    </label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                           x-model="settings.alertProxyUsage" 
                                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-700">
                                        Uso de Proxy/VPN
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-cogs text-primary-500 mr-2"></i>
                                Configuración del Sistema
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Tema de Color
                                    </label>
                                    <select x-model="settings.theme" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="light">Claro</option>
                                        <option value="dark">Oscuro</option>
                                        <option value="auto">Automático</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Idioma
                                    </label>
                                    <select x-model="settings.language" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="es">Español</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Settings Button -->
                    <div class="mt-6 flex justify-end">
                        <button @click="saveSettings()" 
                                class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-md font-medium transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar Configuración
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Details Modal -->
    <div x-show="showSessionModal" 
         x-cloak
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         @click.self="showSessionModal = false">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-user-shield text-primary-500 mr-3"></i>
                        Análisis Detallado de Sesión
                    </h3>
                    <button @click="showSessionModal = false" 
                            class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <template x-if="selectedSession">
                    <div class="space-y-6">
                        <!-- Session Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-fingerprint text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm opacity-90">Session ID</p>
                                        <p class="font-bold text-lg" x-text="selectedSession.session_id"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-globe text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm opacity-90">IP Address</p>
                                        <p class="font-bold text-lg" x-text="selectedSession.ip_address"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm opacity-90">Ubicación</p>
                                        <p class="font-bold text-lg" x-text="selectedSession.country || 'N/A'"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-shield-alt text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm opacity-90">Nivel de Riesgo</p>
                                        <p class="font-bold text-lg" x-text="selectedSession.risk_level || 'Bajo'"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Device & Browser Info -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-desktop text-primary-500 mr-2"></i>
                                    Información del Dispositivo
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Navegador:</span>
                                        <span class="font-medium flex items-center">
                                            <i :class="getBrowserIcon(selectedSession.user_agent)" class="mr-2"></i>
                                            <span x-text="extractBrowser(selectedSession.user_agent)"></span>
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Sistema Operativo:</span>
                                        <span class="font-medium" x-text="selectedSession.os || 'Desconocido'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Resolución:</span>
                                        <span class="font-medium" x-text="selectedSession.screen_resolution || 'N/A'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Zona Horaria:</span>
                                        <span class="font-medium" x-text="selectedSession.timezone || 'N/A'"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-clock text-primary-500 mr-2"></i>
                                    Información Temporal
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Primera Visita:</span>
                                        <span class="font-medium" x-text="formatDate(selectedSession.timestamp)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Última Actividad:</span>
                                        <span class="font-medium" x-text="getTimeAgo(selectedSession.timestamp)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Duración:</span>
                                        <span class="font-medium" x-text="selectedSession.session_duration || 'N/A'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Páginas Visitadas:</span>
                                        <span class="font-medium" x-text="selectedSession.page_views || '1'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Geolocation Details -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-map text-primary-500 mr-2"></i>
                                Detalles de Geolocalización
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">País</p>
                                    <p class="font-medium" x-text="selectedSession.country || 'N/A'"></p>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">Ciudad</p>
                                    <p class="font-medium" x-text="selectedSession.city || 'N/A'"></p>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">ISP</p>
                                    <p class="font-medium" x-text="selectedSession.isp || 'N/A'"></p>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">Latitud</p>
                                    <p class="font-medium" x-text="selectedSession.latitude || 'N/A'"></p>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">Longitud</p>
                                    <p class="font-medium" x-text="selectedSession.longitude || 'N/A'"></p>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600">Proxy/VPN</p>
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                          :class="selectedSession.is_proxy ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                          x-text="selectedSession.is_proxy ? 'Detectado' : 'No detectado'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Analysis -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-exclamation-triangle text-primary-500 mr-2"></i>
                                Análisis de Riesgo
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <div class="text-2xl font-bold" :class="getRiskBadgeClass(selectedSession.risk_level)" x-text="selectedSession.risk_score || '0'"></div>
                                    <p class="text-sm text-gray-600 mt-1">Puntuación de Riesgo</p>
                                </div>
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600" x-text="selectedSession.threat_indicators?.length || '0'"></div>
                                    <p class="text-sm text-gray-600 mt-1">Indicadores de Amenaza</p>
                                </div>
                                <div class="text-center p-4 bg-gray-50 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600" x-text="selectedSession.automation_score || '0'"></div>
                                    <p class="text-sm text-gray-600 mt-1">Puntuación de Bot</p>
                                </div>
                            </div>
                        </div>

                        <!-- Raw Data -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-code text-primary-500 mr-2"></i>
                                    Datos Técnicos Completos
                                </h4>
                                <button @click="copyToClipboard(JSON.stringify(selectedSession, null, 2))"
                                        class="bg-primary-500 hover:bg-primary-600 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-copy mr-1"></i>Copiar JSON
                                </button>
                            </div>
                            <div class="max-h-64 overflow-y-auto">
                                <pre class="json-viewer bg-gray-50 p-4 rounded-md text-sm" x-text="JSON.stringify(selectedSession, null, 2)"></pre>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div x-show="showToast" 
         x-cloak
         x-transition:enter="transform ease-out duration-300 transition"
         x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
         x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-4 right-4 z-50">
        <div :class="toastType === 'success' ? 'bg-green-500' : toastType === 'error' ? 'bg-red-500' : 'bg-blue-500'" 
             class="text-white px-6 py-3 rounded-lg shadow-lg">
            <span x-text="toastMessage"></span>
        </div>
    </div>

    <script>
        function dashboardApp() {
            return {
                // State
                activeSection: 'dashboard',
                currentTime: '',
                autoRefresh: true,
                showSettings: false,
                showSessionModal: false,
                showToast: false,
                toastMessage: '',
                toastType: 'info',
                
                // Data
                stats: {},
                sessions: [],
                selectedSession: null,
                
                // UI state for sessions
                sessionFilter: '',
                filterRisk: '',
                filterCountry: '',
                filterTimeRange: '',
                sortField: 'timestamp',
                sortDirection: 'desc',
                currentPage: 1,
                sessionsPerPage: 10,
                
                // Settings
                settings: {
                    locationPersistence: 30,
                    locationInterval: 5,
                    highAccuracyLocation: true,
                    dataRetention: 30,
                    autoCleanup: true,
                    alertHighRisk: true,
                    alertAutomation: true,
                    alertProxyUsage: true,
                    theme: 'light',
                    language: 'es'
                },
                
                // Report Settings
                reportDateFrom: '',
                reportDateTo: '',
                reportIncludeBasic: true,
                reportIncludeLocation: true,
                reportIncludeDevice: true,
                reportIncludeRisk: true,
                reportFormat: 'pdf',
                
                // Menu Items
                menuItems: [
                    { id: 'dashboard', name: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                    { id: 'sessions', name: 'Sesiones', icon: 'fas fa-list' },
                    { id: 'analytics', name: 'Análisis', icon: 'fas fa-chart-line' },
                    { id: 'reports', name: 'Reportes', icon: 'fas fa-file-alt' },
                    { id: 'bait-links', name: 'Enlaces Señuelo', icon: 'fas fa-link' },
                    { id: 'settings', name: 'Configuración', icon: 'fas fa-cog' }
                ],
                
                // Bait Links
                baitLinks: [
                    {
                        id: 1,
                        title: 'Consulta de Beneficios',
                        description: 'Formulario de consulta de beneficios sociales',
                        url: window.location.origin + '/frontend/consulta_beneficio.html',
                        icon: 'fas fa-hand-holding-usd'
                    },
                    {
                        id: 2,
                        title: 'Promociones Nequi',
                        description: 'Página de promociones bancarias',
                        url: window.location.origin + '/frontend/nequi_promociones.html',
                        icon: 'fas fa-credit-card'
                    },
                    {
                        id: 3,
                        title: 'Subsidio Venezolanos',
                        description: 'Formulario de subsidio para migrantes',
                        url: window.location.origin + '/frontend/subsidio_venezolanos.html',
                        icon: 'fas fa-users'
                    }
                ],
                
                // Charts
                charts: {},
                
                // Computed Properties
                get filteredSessions() {
                    let filtered = this.sessions;
                    
                    // Text filter
                    if (this.sessionFilter) {
                        const searchTerm = this.sessionFilter.toLowerCase();
                        filtered = filtered.filter(session => 
                            session.ip_address?.toLowerCase().includes(searchTerm) ||
                            session.country?.toLowerCase().includes(searchTerm) ||
                            session.browser?.toLowerCase().includes(searchTerm) ||
                            session.user_agent?.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Risk filter
                    if (this.filterRisk) {
                        filtered = filtered.filter(session => session.risk_level === this.filterRisk);
                    }
                    
                    // Country filter
                    if (this.filterCountry) {
                        filtered = filtered.filter(session => session.country === this.filterCountry);
                    }
                    
                    // Time range filter
                    if (this.filterTimeRange) {
                        const now = new Date();
                        const timeRanges = {
                            '1h': 1 * 60 * 60 * 1000,
                            '24h': 24 * 60 * 60 * 1000,
                            '7d': 7 * 24 * 60 * 60 * 1000,
                            '30d': 30 * 24 * 60 * 60 * 1000
                        };
                        
                        const rangeMs = timeRanges[this.filterTimeRange];
                        if (rangeMs) {
                            const cutoffTime = new Date(now.getTime() - rangeMs);
                            filtered = filtered.filter(session => 
                                new Date(session.timestamp) >= cutoffTime
                            );
                        }
                    }
                    
                    // Sort
                    filtered.sort((a, b) => {
                        let aVal = a[this.sortField];
                        let bVal = b[this.sortField];
                        
                        if (this.sortField === 'timestamp') {
                            aVal = new Date(aVal);
                            bVal = new Date(bVal);
                        }
                        
                        if (this.sortDirection === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                    
                    return filtered;
                },
                
                // Initialize
                init() {
                    this.updateTime();
                    this.loadSettings();
                    this.loadDashboardData();
                    this.loadSessions(); // Cargar sesiones al inicializar
                    
                    // Update time every second
                    setInterval(() => this.updateTime(), 1000);
                    
                    // Auto refresh data
                    setInterval(() => {
                        if (this.autoRefresh) {
                            this.refreshCurrentSection();
                        }
                    }, 30000);
                },
                
                // Time Management
                updateTime() {
                    this.currentTime = new Date().toLocaleString('es-ES');
                },
                
                // Data Loading
                async loadDashboardData() {
                    try {
                        const response = await fetch('backend/api-endpoints.php/statistics');
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.stats = {
                            totalSessions: data.total_sessions,
                            uniqueIPs: data.unique_ips,
                            automationDetected: data.automation_detected,
                            proxyUsage: data.proxy_usage
                        };
                        
                        // Update charts with timeout to prevent infinite loops
                        setTimeout(() => {
                            try {
                                if (data.risk_levels) this.updateRiskChart(data.risk_levels);
                                if (data.countries) this.updateCountryChart(data.countries);
                                if (data.activity) this.updateActivityChart(data.activity);
                                if (data.browsers) this.updateBrowserChart(data.browsers);
                            } catch (chartError) {
                                console.error('Error updating charts:', chartError);
                            }
                        }, 100);
                        
                    } catch (error) {
                        console.error('Error loading dashboard data:', error);
                        this.showToastMessage('Error cargando datos del dashboard', 'error');
                    }
                },
                
                async loadSessions() {
                    try {
                        const response = await fetch('backend/api-endpoints.php/sessions?limit=1000');
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.sessions = data.sessions || [];
                        this.showToastMessage('Sesiones actualizadas correctamente', 'success');
                        
                    } catch (error) {
                        console.error('Error loading sessions:', error);
                        this.showToastMessage('Error cargando sesiones', 'error');
                    }
                },
                
                async viewSession(sessionId) {
                    try {
                        const response = await fetch(`backend/api-endpoints.php/session?id=${sessionId}`);
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.selectedSession = data;
                        this.showSessionModal = true;
                        
                    } catch (error) {
                        console.error('Error loading session details:', error);
                        this.showToastMessage('Error cargando detalles de sesión', 'error');
                    }
                },
                
                async analyzeRisk(sessionId) {
                    try {
                        const response = await fetch(`backend/api-endpoints.php/risk-analysis?session_id=${sessionId}`);
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Show risk analysis in modal or toast
                        this.showToastMessage(`Riesgo: ${data.risk_level.toUpperCase()} (${data.risk_score}%)`, 
                                            data.risk_level === 'alto' ? 'error' : data.risk_level === 'medio' ? 'warning' : 'success');
                        
                    } catch (error) {
                        console.error('Error analyzing risk:', error);
                        this.showToastMessage('Error analizando riesgo', 'error');
                    }
                },
                
                // Session Management Functions
                get filteredSessions() {
                    let filtered = this.sessions;
                    
                    if (this.sessionFilter) {
                        const filter = this.sessionFilter.toLowerCase();
                        filtered = filtered.filter(session => 
                            session.client_ip?.toLowerCase().includes(filter) ||
                            session.location?.toLowerCase().includes(filter) ||
                            session.browser_info?.browser?.toLowerCase().includes(filter) ||
                            session.browser_info?.os?.toLowerCase().includes(filter) ||
                            session.session_id?.toLowerCase().includes(filter)
                        );
                    }
                    
                    // Sort
                    filtered.sort((a, b) => {
                        let aVal = a[this.sortField];
                        let bVal = b[this.sortField];
                        
                        if (this.sortField === 'timestamp') {
                            aVal = new Date(aVal);
                            bVal = new Date(bVal);
                        }
                        
                        if (this.sortDirection === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                    
                    return filtered;
                },
                
                get totalPages() {
                    return Math.ceil(this.filteredSessions.length / this.sessionsPerPage);
                },
                
                get visiblePages() {
                    const pages = [];
                    const total = this.totalPages;
                    const current = this.currentPage;
                    
                    // Show up to 5 pages around current page
                    let start = Math.max(1, current - 2);
                    let end = Math.min(total, current + 2);
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    
                    return pages;
                },
                
                sortSessions(field) {
                    if (this.sortField === field) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        this.sortDirection = 'desc';
                    }
                    this.currentPage = 1; // Reset to first page when sorting
                },
                
                previousPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                    }
                },
                
                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                    }
                },
                
                exportSession(sessionId) {
                    const session = this.sessions.find(s => s.session_id === sessionId);
                    if (session) {
                        const dataStr = JSON.stringify(session, null, 2);
                        const dataBlob = new Blob([dataStr], {type: 'application/json'});
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `session_${sessionId.substring(0, 8)}.json`;
                        link.click();
                        URL.revokeObjectURL(url);
                        this.showToastMessage('Sesión exportada correctamente', 'success');
                    }
                },
                
                // Chart Updates
                updateRiskChart(riskData) {
                    try {
                        const ctx = document.getElementById('riskChart');
                        if (!ctx) return;
                        
                        if (this.charts.risk) {
                            this.charts.risk.destroy();
                            this.charts.risk = null;
                        }
                        
                        this.charts.risk = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Alto', 'Medio', 'Bajo'],
                                datasets: [{
                                    data: [riskData.alto || 0, riskData.medio || 0, riskData.bajo || 0],
                                    backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false, // Disable animations to prevent loops
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error creating risk chart:', error);
                    }
                },
                
                updateCountryChart(countryData) {
                    try {
                        const ctx = document.getElementById('countryChart');
                        if (!ctx) return;
                        
                        if (this.charts.country) {
                            this.charts.country.destroy();
                            this.charts.country = null;
                        }
                        
                        const countries = Object.keys(countryData || {}).slice(0, 5);
                        const counts = countries.map(country => countryData[country]);
                        
                        this.charts.country = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: countries,
                                datasets: [{
                                    label: 'Sesiones',
                                    data: counts,
                                    backgroundColor: '#3b82f6'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false, // Disable animations to prevent loops
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error creating country chart:', error);
                    }
                },

                updateActivityChart(activityData) {
                    try {
                        const ctx = document.getElementById('activityChart');
                        if (!ctx) return;
                        
                        if (this.charts.activity) {
                            this.charts.activity.destroy();
                            this.charts.activity = null;
                        }
                        
                        // Generate hourly data for last 24 hours
                        const hours = [];
                        const data = [];
                        for (let i = 23; i >= 0; i--) {
                            const hour = new Date();
                            hour.setHours(hour.getHours() - i);
                            hours.push(hour.getHours() + ':00');
                            data.push(Math.floor(Math.random() * 50)); // Mock data
                        }
                        
                        this.charts.activity = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: hours,
                                datasets: [{
                                    label: 'Sesiones',
                                    data: data,
                                    borderColor: '#8b5cf6',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false, // Disable animations to prevent loops
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error creating activity chart:', error);
                    }
                },

                updateBrowserChart(browserData) {
                    try {
                        const ctx = document.getElementById('browserChart');
                        if (!ctx) return;
                        
                        if (this.charts.browser) {
                            this.charts.browser.destroy();
                            this.charts.browser = null;
                        }
                        
                        // Mock browser data
                        const browsers = ['Chrome', 'Firefox', 'Safari', 'Edge', 'Otros'];
                        const data = [45, 25, 15, 10, 5];
                        const colors = ['#4285f4', '#ff7139', '#00d4aa', '#0078d4', '#6c757d'];
                        
                        this.charts.browser = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: browsers,
                                datasets: [{
                                    data: data,
                                    backgroundColor: colors
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false, // Disable animations to prevent loops
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error creating browser chart:', error);
                    }
                },
                
                // Utility Functions
                extractBrowser(userAgent) {
                    if (!userAgent) return 'Desconocido';
                    if (userAgent.includes('Chrome')) return 'Chrome';
                    if (userAgent.includes('Firefox')) return 'Firefox';
                    if (userAgent.includes('Safari')) return 'Safari';
                    if (userAgent.includes('Edge')) return 'Edge';
                    return 'Otro';
                },
                
                async copyToClipboard(text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        this.showToastMessage('Enlace copiado al portapapeles', 'success');
                    } catch (error) {
                        console.error('Error copying to clipboard:', error);
                        this.showToastMessage('Error copiando enlace', 'error');
                    }
                },
                
                previewBait(url) {
                    window.open(url, '_blank');
                },
                
                // Filter Functions
                clearFilters() {
                    this.sessionFilter = '';
                    this.filterRisk = '';
                    this.filterCountry = '';
                    this.filterTimeRange = '';
                    this.showToastMessage('Filtros limpiados', 'success');
                },
                
                // Report Functions
                generateReport() {
                    if (!this.reportDateFrom || !this.reportDateTo) {
                        this.showToastMessage('Por favor selecciona un rango de fechas', 'error');
                        return;
                    }
                    
                    const reportData = this.getReportData();
                    
                    if (this.reportFormat === 'pdf') {
                        this.generatePDFReport(reportData);
                    } else if (this.reportFormat === 'excel') {
                        this.generateExcelReport(reportData);
                    } else {
                        this.generateCSVReport(reportData);
                    }
                },
                
                getReportData() {
                    const fromDate = new Date(this.reportDateFrom);
                    const toDate = new Date(this.reportDateTo);
                    
                    return this.sessions.filter(session => {
                        const sessionDate = new Date(session.timestamp);
                        return sessionDate >= fromDate && sessionDate <= toDate;
                    });
                },
                
                generatePDFReport(data) {
                    // Mock PDF generation
                    this.showToastMessage('Generando reporte PDF...', 'info');
                    setTimeout(() => {
                        this.showToastMessage('Reporte PDF generado correctamente', 'success');
                    }, 2000);
                },
                
                generateExcelReport(data) {
                    // Mock Excel generation
                    this.showToastMessage('Generando reporte Excel...', 'info');
                    setTimeout(() => {
                        this.showToastMessage('Reporte Excel generado correctamente', 'success');
                    }, 2000);
                },
                
                generateCSVReport(data) {
                    const headers = ['Session ID', 'Timestamp', 'IP Address', 'Location', 'Browser', 'Risk Level'];
                    const csvContent = [
                        headers.join(','),
                        ...data.map(session => [
                            session.session_id,
                            session.timestamp,
                            session.client_ip,
                            session.location || 'N/A',
                            this.extractBrowser(session.user_agent),
                            session.risk_level || 'Bajo'
                        ].join(','))
                    ].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `reporte_${this.reportDateFrom}_${this.reportDateTo}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    this.showToastMessage('Reporte CSV descargado correctamente', 'success');
                },
                
                // Analytics Functions
                getThreatAnalysis() {
                    const total = this.sessions.length;
                    const highRisk = this.sessions.filter(s => s.risk_level === 'Alto').length;
                    const mediumRisk = this.sessions.filter(s => s.risk_level === 'Medio').length;
                    const lowRisk = this.sessions.filter(s => s.risk_level === 'Bajo').length;
                    
                    return {
                        total,
                        highRisk,
                        mediumRisk,
                        lowRisk,
                        riskPercentage: total > 0 ? ((highRisk + mediumRisk) / total * 100).toFixed(1) : 0
                    };
                },
                
                getGeographicAnalysis() {
                    const countries = {};
                    this.sessions.forEach(session => {
                        const country = session.country || 'Desconocido';
                        countries[country] = (countries[country] || 0) + 1;
                    });
                    
                    return Object.entries(countries)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 10)
                        .map(([country, count]) => ({ country, count }));
                },
                
                getBrowserAnalysis() {
                    const browsers = {};
                    this.sessions.forEach(session => {
                        const browser = this.extractBrowser(session.user_agent);
                        browsers[browser] = (browsers[browser] || 0) + 1;
                    });
                    
                    return Object.entries(browsers)
                        .sort(([,a], [,b]) => b - a)
                        .map(([browser, count]) => ({ browser, count }));
                },
                
                // Settings Management
                loadSettings() {
                    const saved = localStorage.getItem('dashboardSettings');
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                },
                
                saveSettings() {
                    localStorage.setItem('dashboardSettings', JSON.stringify(this.settings));
                    this.showToastMessage('Configuración guardada correctamente', 'success');
                    
                    // Apply location settings to frontend integration
                    this.updateFrontendSettings();
                },
                
                updateFrontendSettings() {
                    // This would update the frontend fingerprint integration settings
                    const settingsScript = `
                        if (window.FingerprintManager) {
                            window.FingerprintManager.updateSettings({
                                locationPersistence: ${this.settings.locationPersistence},
                                locationInterval: ${this.settings.locationInterval},
                                highAccuracy: ${this.settings.highAccuracyLocation}
                            });
                        }
                    `;
                    
                    // Could be sent to active sessions via WebSocket or similar
                    console.log('Settings updated:', this.settings);
                },
                
                // Toast Management
                showToastMessage(message, type = 'info') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },
                
                // Utility Functions
                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showToastMessage('Copiado al portapapeles', 'success');
                    }).catch(() => {
                        this.showToastMessage('Error al copiar', 'error');
                    });
                },
                
                formatDate(timestamp) {
                    return new Date(timestamp).toLocaleString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                getTimeAgo(timestamp) {
                    const now = new Date();
                    const time = new Date(timestamp);
                    const diffMs = now - time;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    
                    if (diffMins < 1) return 'Ahora';
                    if (diffMins < 60) return `${diffMins}m`;
                    if (diffHours < 24) return `${diffHours}h`;
                    return `${diffDays}d`;
                },
                
                getBrowserIcon(browser) {
                    const icons = {
                        'Chrome': 'fab fa-chrome text-green-500',
                        'Firefox': 'fab fa-firefox text-orange-500',
                        'Safari': 'fab fa-safari text-blue-500',
                        'Edge': 'fab fa-edge text-blue-600',
                        'Opera': 'fab fa-opera text-red-500'
                    };
                    return icons[browser] || 'fas fa-globe text-gray-500';
                },
                
                getRiskBadgeClass(riskLevel) {
                    const classes = {
                        'alto': 'bg-red-100 text-red-800',
                        'medio': 'bg-yellow-100 text-yellow-800',
                        'bajo': 'bg-green-100 text-green-800'
                    };
                    return classes[riskLevel] || 'bg-gray-100 text-gray-800';
                },
                
                getRiskIcon(riskLevel) {
                    const icons = {
                        'alto': 'fas fa-exclamation-triangle',
                        'medio': 'fas fa-exclamation-circle',
                        'bajo': 'fas fa-check-circle'
                    };
                    return icons[riskLevel] || 'fas fa-question-circle';
                },
                
                extractBrowser(userAgent) {
                    if (!userAgent) return 'Desconocido';
                    
                    if (userAgent.includes('Chrome')) return 'Chrome';
                    if (userAgent.includes('Firefox')) return 'Firefox';
                    if (userAgent.includes('Safari')) return 'Safari';
                    if (userAgent.includes('Edge')) return 'Edge';
                    if (userAgent.includes('Opera')) return 'Opera';
                    
                    return 'Otro';
                },
                
                // Refresh Current Section
                refreshCurrentSection() {
                    switch(this.activeSection) {
                        case 'dashboard':
                            this.loadDashboardData();
                            break;
                        case 'sessions':
                            this.loadSessions();
                            break;
                    }
                }
            }
        }
    </script>
</body>
</html>